require("dotenv").config();const sass=require("./config/sass-process.js"),cleanCSS=require("clean-css"),fs=require("fs"),pluginRSS=require("@11ty/eleventy-plugin-rss"),localImages=require("eleventy-plugin-local-images"),lazyImages=require("eleventy-plugin-lazyimages"),ghostContentAPI=require("@tryghost/content-api");sass("./src/_assets/sass/main.scss","./dist/assets/styles/main.css"),sass("./src/_assets/sass/main.scss","./src/_assets/styles/main.css");const htmlMinTransform=require("./src/transforms/html-min-transform.js"),api=new ghostContentAPI({url:process.env.GHOST_API_URL,key:process.env.GHOST_CONTENT_API_KEY,version:"v3"}),stripDomain=s=>s.replace(process.env.GHOST_API_URL,"");module.exports=function(s){return s.addTransform("htmlmin",htmlMinTransform),s.addPlugin(pluginRSS),s.addPlugin(lazyImages,{cacheFile:""}),s.addLayoutAlias("author","author.njk"),s.addLayoutAlias("post","post.njk"),s.addLayoutAlias("tag","tag.njk"),s.addLayoutAlias("post","post.pug"),s.addLayoutAlias("doc","doc.njk"),s.addLayoutAlias("docs","/docs/docs.njk"),s.addLayoutAlias("default.njk","default.njk"),s.addLayoutAlias("tags","tag.njk"),s.addLayoutAlias("posts","post.njk"),s.addPassthroughCopy("./src/_assets/","/assets/"),s.addPlugin(localImages,{distPath:"dist",assetPath:"/assets/images",selector:"img",attribute:"data-src",verbose:!1}),s.addFilter("cssmin",s=>new cleanCSS({}).minify(s).styles),s.addFilter("getReadingTime",s=>{const a=s.split(/\s/g).length;return Math.ceil(a/200)}),s.addFilter("htmlDateString",s=>new Date(s).toISOString().split("T")[0]),s.setUseGitIgnore(!1),s.addCollection("docs",(async function(s){return(s=await api.pages.browse({include:"authors",limit:"all"}).catch(s=>{console.error(s)})).map(s=>(s.url=stripDomain(s.url),s.primary_author.url=stripDomain(s.primary_author.url),s.published_at=new Date(s.published_at),s)),s})),s.addCollection("posts",(async function(s){return(s=await api.posts.browse({include:"tags,authors",limit:"all"}).catch(s=>{console.error(s)})).forEach(s=>{s.url=stripDomain(s.url),s.primary_author.url=stripDomain(s.primary_author.url),s.tags.map(s=>s.url=stripDomain(s.url)),s.published_at=new Date(s.published_at)}),s.sort((s,a)=>a.featured-s.featured),s})),s.addCollection("authors",(async function(s){s=await api.authors.browse({limit:"all"}).catch(s=>{console.error(s)});const a=await api.posts.browse({include:"authors",limit:"all"}).catch(s=>{console.error(s)});return s.forEach(async s=>{const t=a.filter(a=>(a.url=stripDomain(a.url),a.primary_author.id===s.id));t.length&&(s.posts=t),s.url=stripDomain(s.url)}),s})),s.addCollection("tags",(async function(s){s=await api.tags.browse({include:"count.posts",limit:"all"}).catch(s=>{console.error(s)});const a=await api.posts.browse({include:"tags,authors",limit:"all"}).catch(s=>{console.error(s)});return s.forEach(async s=>{const t=a.filter(a=>(a.url=stripDomain(a.url),a.primary_tag&&a.primary_tag.slug===s.slug));t.length&&(s.posts=t),s.url=stripDomain(s.url)}),s})),s.setBrowserSyncConfig({callbacks:{ready:(s,a)=>{a.addMiddleware("*",(s,a)=>{a.end()})}}}),{dir:{input:"./src",output:"./dist"},templateFormats:["css","njk","md","txt"],htmlTemplateEngine:"njk",markdownTemplateEngine:"njk",passthroughFileCopy:!0}};